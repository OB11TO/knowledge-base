---
title: Session от Tomcat
tags:
  - JavaEE
related_topics: 
created: 2024-09-11 13:58
modified: 2024-11-07T13:48:46+03:00
questions: 
notes: 
links: 
---

### Session от Tomcat

==Сессия с помощью куки определяет одна и та же эта сессия или нет.==

- Это всё `происходит в недрах Каталины.`
- Есть класс `Request` из ==Catalina==, который обертка над классом `Request` из ==Cayota==
- Достаем из ==Contexta== сессию, ==так как в томкате могут крутиться несколько приложений и у каждого будет свой контекст.==
- Из ==Manager== сессий, ==получаем сессию== по `jsessionId`
- Иначе ==создать== ==session==, со всеми данными и кладем в map с новый генерированным `jsessionId`

![[Untitled 52.png]]

![[Untitled 53.png]]

### Что такое сессия в сервлетах?

Сессия в сервлетах — это механизм, <mark class="hltr-yellow">позволяющий сохранять состояние между запросами от одного и того же пользователя</mark>. <mark class="hltr-red">HTTP-протокол является **безсостоящим** (stateless)</mark>, что означает, что <mark class="hltr-green2">каждый запрос от клиента к серверу обрабатывается как независимый, без сохранения данных о предыдущих запросах.</mark> Сессии позволяют сохранять информацию о пользователе (например, данные авторизации, корзину покупок и т.д.) между запросами на время, пока пользователь взаимодействует с приложением.

В Java сервлетах для управления сессиями используется интерфейс **`HttpSession`**, который предоставляет методы для сохранения данных между запросами.

### Для чего нужны атрибуты в сессии?

Атрибуты в сессии используются для **сохранения данных, относящихся к пользователю**, на протяжении всей его сессии. <mark class="hltr-yellow">Эти данные доступны во всех запросах, которые пользователь отправляет на сервер в рамках своей текущей сессии</mark>. Атрибуты представляют собой пары "ключ-значение" и позволяют хранить произвольные объекты в сессии.

#### Основные сценарии использования атрибутов сессии:

1. **Хранение информации о пользователе**: Например, можно сохранить данные о том, что пользователь вошел в систему, и связать с ним объект `User`.
```java
// Установка атрибута в сессии
HttpSession session = request.getSession();
session.setAttribute("user", new User("John", "Doe"));

// Получение атрибута из сессии
User user = (User) session.getAttribute("user");

```

1. **Хранение временных данных**: Например, корзина покупок в интернет-магазине или выбранные настройки пользователя. Эти данные сохраняются между запросами, пока пользователь активен.
    
2. **Хранение токенов или параметров безопасности**: Можно хранить уникальные идентификаторы сессии, токены для проверки подлинности или ключи для защиты от CSRF-атак.
    

### Методы работы с атрибутами сессии:

- **`setAttribute(String name, Object value)`** — устанавливает атрибут в сессии. Если атрибут с таким именем уже существует, он будет перезаписан.
- **`getAttribute(String name)`** — возвращает атрибут по имени. Если атрибут не найден, возвращает `null`.
- **`removeAttribute(String name)`** — удаляет атрибут с указанным именем из сессии.
- **`invalidate()`** — завершает сессию и удаляет все её атрибуты.

### Для чего нужна сессия в сервлетах?

Основная цель сессий в сервлетах — это **обеспечить возможность сохранения состояния** между запросами клиента, а также облегчить работу с данными, относящимися к конкретному пользователю на протяжении его работы с веб-приложением. Сессия позволяет реализовывать такие функции, как:

1. **Аутентификация**: После успешного входа в систему информация о пользователе (например, логин) сохраняется в сессии, чтобы проверять права доступа на каждой странице.
2. **Корзина покупок**: В интернет-магазинах информация о товарах, добавленных в корзину, сохраняется в сессии до завершения заказа.
3. **Персонализация**: Сессии можно использовать для сохранения пользовательских настроек (например, язык или темы интерфейса).

### Где хранится сессия?

Веб-серверы используют различные подходы для хранения данных сессии. В Java сервлетах есть несколько вариантов хранения сессий:

1. **На сервере (по умолчанию)**: Данные сессии хранятся на стороне сервера в памяти (например, в `HttpSession`). Каждому пользователю присваивается уникальный идентификатор сессии (`Session ID`), который хранится на клиенте в виде cookie или передается через URL-параметры. Этот идентификатор используется для того, чтобы сопоставить запрос с нужной сессией на сервере.
    
    - **Cookie**: При первом запросе создается сессия, и сервер отправляет клиенту cookie с идентификатором сессии. При каждом следующем запросе браузер отправляет этот cookie, позволяя серверу идентифицировать сессию.
    - **URL-параметры**: Если у клиента отключены cookie, идентификатор сессии может передаваться через URL (это менее предпочтительно по соображениям безопасности).
2. **На клиенте (безопасные сессии)**: В некоторых случаях может быть использовано хранение минимальных данных на клиентской стороне (например, сессионные токены), однако основные данные хранятся на сервере. Это может быть нужно, если сервер должен быть "stateless", но сессия всё равно нужна (например, в распределенных системах).
    
3. **На сервере в распределенных системах**: В случае кластеризованных приложений (когда несколько серверов обрабатывают запросы параллельно) данные сессии могут храниться в базе данных, в распределенной памяти (например, с использованием Redis) или использоваться механизмы для репликации сессий между серверами.
    

### Пример работы с сессией

Пример использования сессии для сохранения информации о пользователе после входа в систему:
```java
@WebServlet("/login")
public class LoginServlet extends HttpServlet {

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // Получаем параметры от пользователя
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        
        // Простая проверка данных
        if ("admin".equals(username) && "password".equals(password)) {
            // Получаем или создаем новую сессию
            HttpSession session = request.getSession();
            
            // Сохраняем информацию о пользователе в сессии
            session.setAttribute("user", username);
            
            // Перенаправляем на защищенную страницу
            response.sendRedirect("welcome.jsp");
        } else {
            // Неправильный логин или пароль
            response.getWriter().println("Invalid login credentials");
        }
    }
}

```

На другой странице (например, `welcome.jsp`) можно получить информацию о пользователе из сессии:

```jsp
<%
    HttpSession session = request.getSession(false); // false означает, что сессия не будет создана, если её нет
    if (session != null) {
        String username = (String) session.getAttribute("user");
        if (username != null) {
            out.println("Welcome, " + username);
        } else {
            out.println("No user logged in");
        }
    } else {
        out.println("No session found");
    }
%>

```

### Заключение

Сессия и её атрибуты в Java сервлетах — это важный инструмент для сохранения состояния между запросами пользователя. Сессии позволяют хранить пользовательские данные (например, информацию о входе или данные корзины покупок) на протяжении всего времени взаимодействия пользователя с приложением. Атрибуты сессии позволяют удобно передавать данные между запросами, а сессия на стороне сервера обеспечивает безопасность и контроль над тем, как долго данные сохраняются.