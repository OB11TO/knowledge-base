---
title: Redis Streams
tags:
  - Redis
related_topics: 
created: 2024-09-23 17:00
modified: 2024-09-23T17:04:29+03:00
questions: 
notes: 
links: 
---


<mark class="hltr-red">Redis Streams (потоки Redis)</mark> — это относительно новая функциональность Redis, добавленная в версии 5.0. Она представляет собой реализацию **логов событий**, которая имеет некоторые общие черты с системами, такими как Apache Kafka. Однако Redis Streams, как и вся экосистема Redis, ориентирована на скорость и простоту использования в памяти, что отличает её от более тяжелых и специализированных решений, таких как Kafka.

Давай детально рассмотрим, что такое Redis Streams, их особенности и как они отличаются от других механизмов, таких как Redis Pub/Sub и Kafka.

## 1. **Основные концепции Redis Streams**

### Что такое Redis Streams?

Redis Streams — это **асинхронная структура данных**, предназначенная для **передачи сообщений** с поддержкой:

- **Множественных потребителей** (consumer groups).
- **Сохранения сообщений** (персистентность), что делает возможным повторное чтение сообщений.
- **Исторического доступа к данным** (подписчики могут читать старые сообщения).

Каждое сообщение в потоке состоит из идентификатора (ID) и набора ключ-значение (данные сообщения).

### Пример структуры потока:
```java
ID:  1623334435000-0
Data: { field1: "value1", field2: "value2" }

```

### Основные возможности Redis Streams:

- **Сохранение сообщений**<mark class="hltr-yellow">: Сообщения сохраняются в потоке до тех пор, пока вы их не удалите вручную или не примените политику удаления </mark>(например, ограничение на размер или время хранения).
- **Повторное чтение сообщений**:<mark class="hltr-yellow"> Сообщения могут быть прочитаны подписчиками несколько раз, даже после того, как они были опубликованы.</mark>
- **Группы потребителей** (**consumer groups**): Несколько клиентов могут читать поток сообщений, и каждый из них будет получать свою часть данных.
- **Автоматическое назначение сообщений**: Redis Streams <mark class="hltr-yellow">автоматически распределяет сообщения между потребителями внутри группы.</mark>
- **Поддержка сложных сценариев обработки, таких как отложенные/повторные сообщения**.

## 2. **Ключевые особенности Redis Streams**

### 2.1. **Персистентность данных**

В отличие от **Redis Pub/Sub**, где сообщения теряются, если подписчики их не получили вовремя, Redis Streams **хранят сообщения до тех пор, пока они явно не удалены**. Это делает их намного более устойчивыми и подходящими для сценариев, когда потребители могут быть временно недоступны.

### 2.2. **Consumer Groups (группы потребителей)**

Это одно из ключевых отличий Redis Streams от Pub/Sub и одна из главных причин, почему Streams можно сравнивать с Kafka.

- В **Pub/Sub** каждое сообщение отправляется всем подписчикам в реальном времени, и если подписчик недоступен, он не получит сообщение.
- В **Redis Streams** можно создать **группы потребителей**. Каждое сообщение в потоке будет назначаться одному из потребителей внутри группы. Если один потребитель недоступен, другой потребитель в той же группе может обработать сообщение.

Пример:

- У вас есть поток сообщений, который должен быть обработан несколькими сервисами.
- Вы создаёте группу потребителей, и каждый потребитель будет получать свою часть сообщений, обрабатывая их параллельно.
- Это схоже с тем, как работает **Kafka Consumer Groups**.

### 2.3. **Автоматическое назначение и повторное назначение сообщений**

Redis Streams следит за тем, какие сообщения были получены каждым потребителем. Если сообщение не было обработано (например, потребитель упал), вы можете переназначить это сообщение другому потребителю внутри группы. Это важная функциональность для обеспечения отказоустойчивости.

### 2.4. **ID сообщений**

Каждое сообщение в Redis Streams имеет уникальный идентификатор (например, `1623334435000-0`), который отражает **время создания** и **порядковый номер**. Эти идентификаторы позволяют отслеживать и управлять обработкой сообщений.

### 2.5. **Ретеншн сообщений (удаление старых сообщений)**

Redis Streams поддерживает **ограничение размера потока**:

- <mark class="hltr-yellow">Можно настроить поток так, чтобы он автоматически удалял старые сообщения, как только их количество превысит установленный лимит.</mark>
- <mark class="hltr-yellow">Можно настроить удаление сообщений по времени, например, чтобы хранить их только в течение 1 дня.</mark>

### 2.6. **Асинхронная обработка и блокировка**

Redis Streams поддерживает блокирующие операции, что позволяет клиентам ожидать появления новых сообщений без постоянного опроса потока.

### Пример команды для блокирующего чтения:
```java
XREAD BLOCK 0 STREAMS mystream $
```

## 3. **Сравнение Redis Streams с Redis Pub/Sub и Kafka**

### Redis Streams vs Redis Pub/Sub

|**Характеристика**|**Redis Streams**|**Redis Pub/Sub**|
|---|---|---|
|**Хранение сообщений**|Сообщения сохраняются до удаления|Сообщения не сохраняются|
|**Группы потребителей**|Поддерживаются|Не поддерживаются|
|**Гарантии доставки**|Поддержка подтверждений сообщений|Нет гарантий доставки|
|**Повторное чтение**|Возможно|Невозможно|
||||