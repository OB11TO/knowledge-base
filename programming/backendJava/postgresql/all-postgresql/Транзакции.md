---
title: Транзакции
tags:
  - PostgreSql
related_topics: 
created: 2024-09-24 14:30
modified: 2025-04-22T13:37:41+03:00
questions: 
notes: 
links: 
---

----
[[ACID]]
[[Уровень изоляции транзакций]]

[[Проблемы при работе с транзакциями]]
[[Propagation]]
[[Советы про транзакции и паттерны]]

[[Ещё про Транзакции]]

[[Виртуальные транзакции]]
[[Вложенные транзакции]]
[[Снимки транзакций]]

[[Переполнение счетчика транзакций]]

----

<mark class="hltr-red">Транзакцией называется</mark> <mark class="hltr-yellow">множество операций, выполняемое приложением, которое переводит базу данных из одного корректного состояния в другое корректное состояние (согласованность) при условии, что транзакция выполнена полностью (атомарность) и без помех со стороны других транзакций (изоляция).</mark>

![[Pasted image 20241002154827.png]]
![[Pasted image 20241008173019.png]]

### Почему результат транзакции не записывается сразу?

Когда происходит **вставка новой строки**, транзакция ещё находится в процессе выполнения и не знает своего финального результата — завершится ли она успешно или будет отменена. То есть на этапе создания строки система просто ещё не может знать, как завершится транзакция.

### Что происходит при фиксации (commit) транзакции?

Когда транзакция завершилась, она должна зафиксировать изменения — это называется **commit**. В этот момент нужно записать результат: прошла транзакция успешно или нет. Однако есть **несколько проблем**, которые мешают сразу записать результат транзакции в сами строки:

1. **Неизвестно, какие строки изменены**: На момент фиксации база данных может не сразу знать, какие именно строки и на каких страницах были изменены. Это связано с тем, что транзакции могут изменять много строк на разных страницах памяти, и собирать информацию обо всех изменённых строках неудобно и может быть дорого с точки зрения ресурсов.
     
2. **Слишком много данных для записи**: Когда транзакция завершена, нужно обновить все строки, которые она затронула, чтобы записать в них результат (успех или отмену). Но таких строк может быть очень много, и обновление всех их сразу займёт много времени и замедлит систему.
    
3. **Часть страниц может находиться вне оперативной памяти**: Не все изменённые страницы памяти (где хранятся строки) могут находиться в оперативной памяти (RAM) базы данных. Некоторые могут быть выгружены на диск. Если пытаться сразу обновить такие страницы, это приведёт к дополнительным затратам на чтение данных с диска, что замедлит работу базы данных.


### Как решается эта проблема?

Для решения этих проблем база данных использует журнал транзакций (XACT). Когда транзакция завершена, её результат (успех или отмена) записывается **в журнал транзакций (XACT)**. Этот журнал проще обновить, потому что это централизованная структура, в которой фиксируется результат транзакции, а не результат для каждой строки.

Когда в следующий раз кто-то попытается прочитать строку, созданную этой транзакцией, база данных посмотрит в журнал транзакций (XACT) или в специальные биты (`xmin_committed` и `xmin_aborted`), чтобы узнать, завершилась ли транзакция успешно или была отменена.

### Итог

Записывать результат транзакции сразу в каждую строку неудобно и слишком дорого по времени, потому что:

- Неизвестно, какие строки были изменены;
- Изменённых строк может быть очень много;
- Некоторые страницы с этими строками могут быть выгружены на диск.

Поэтому база данных сначала фиксирует результат транзакции в журнале XACT, а биты (`xmin_committed` и `xmin_aborted`) в строках обновляются только при необходимости, чтобы ускорить дальнейшую работу.
