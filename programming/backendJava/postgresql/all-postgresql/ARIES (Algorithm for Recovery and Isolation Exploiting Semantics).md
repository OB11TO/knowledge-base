---
title: ARIES (Algorithm for Recovery and Isolation Exploiting Semantics)
tags:
  - PostgreSql
related_topics: 
created: 2024-09-27 12:54
modified: 2024-09-27T13:00:13+03:00
questions: 
notes: 
links: 
---

Алгоритм **ARIES (Algorithm for Recovery and Isolation Exploiting Semantics)** — <mark class="hltr-red">это продвинутая методика восстановления данных в системах управления базами данных (СУБД) после сбоев. ARIES используется для того, чтобы обеспечить **журналируемую запись** (logging), **восстановление** (recovery) после сбоев и **сохранение целостности транзакций** в базе данных, минимизируя при этом потери данных и время простоя. ARIES был разработан для обеспечения высокой производительности и гибкости в системах, которые используют сложные транзакционные модели, включая параллельную обработку.</mark>

Алгоритм ARIES использует три основные концепции:

1. **Write-Ahead Logging (WAL)** — Запись вперед.
2. **Повторное выполнение (Redo) и откат (Undo)**.
3. **Контрольные точки (Checkpoints)**.

Далее я подробно расскажу о каждой из частей алгоритма ARIES и о том, как он работает.

### Основные концепции ARIES

1. **Write-Ahead Logging (WAL)**
    
    Главный принцип **WAL** заключается в том, что все изменения данных должны быть сначала записаны в **журнал транзакций** (лог) до того, как изменения фактически применяются к базе данных. Это обеспечивает безопасность данных в случае сбоя, так как журнал позволяет откатить изменения или повторить их после восстановления.
    
    - Перед тем как данные на странице будут изменены на диске, эти изменения записываются в WAL.
    - Каждая запись в WAL представляет собой **логическую операцию** (например, обновление или удаление строки), а также содержит информацию для её восстановления.
2. **Повторное выполнение (Redo) и Откат (Undo)**
    
    <mark class="hltr-orange">В ARIES для восстановления используются две основные процедуры:</mark>
    
    - **Redo (Повторное выполнение)** —<mark class="hltr-yellow"> применяется для повторного внесения изменений, которые были зафиксированы, но ещё не были записаны на диск.</mark>
    - **Undo (Откат)** — <mark class="hltr-yellow">применяется для отмены изменений транзакций, которые не были зафиксированы на момент сбоя.</mark>
    
    Эти две процедуры гарантируют, что система может вернуться в согласованное состояние после сбоя, независимо от того, на какой стадии выполнения транзакций произошел сбой.
    
3. **Контрольные точки (Checkpoints)**
    
    Чтобы ускорить процесс восстановления, ARIES использует **контрольные точки**.<mark class="hltr-green2"> Контрольная точка — это момент времени, в который система записывает текущее состояние базы данных и журналов. Контрольные точки уменьшают объем данных, которые необходимо просматривать при восстановлении системы после сбоя.</mark>
    
    - Во время контрольной точки в журнал записывается информация о транзакциях, которые активны, и о страницах, которые были изменены.
    - Это позволяет восстановить систему, начиная с последней контрольной точки, не просматривая весь журнал транзакций.

### Этапы восстановления с использованием ARIES

Когда система с использованием ARIES восстанавливается после сбоя, она проходит три ключевых этапа восстановления:

1. **Анализ (Analysis)**
    
    На этом этапе система анализирует журнал транзакций, чтобы определить, какие транзакции были активны на момент сбоя, какие страницы данных были изменены, но не были записаны на диск, и где находится последняя контрольная точка. Цель анализа — подготовить систему к повторному выполнению и откату.
    
    - Выявляются все страницы, которые нуждаются в повторном применении изменений (redo).
    - Определяются активные на момент сбоя транзакции, которые требуют отката (undo).
2. **Повторное выполнение (Redo)**
    
    После анализа начинается этап **Redo**, который отвечает за повторное выполнение всех изменений, которые уже были зафиксированы, но которые не успели быть записаны на диск. Важно отметить, что ARIES не повторяет все изменения, а только те, которые действительно были зафиксированы, но не записаны.
    
    - Redo выполняет все операции начиная с последней контрольной точки.
    - Это позволяет восстановить базу данных в то состояние, в котором она была на момент сбоя.
3. **Откат (Undo)**
    
    На этапе **Undo** система отменяет все изменения, сделанные транзакциями, которые были активны на момент сбоя, но не были зафиксированы (не завершились успешно). Откат происходит в обратном порядке, начиная с последней активной транзакции, чтобы сохранить последовательность выполнения операций.
    
    - Операции Undo применяются для каждой транзакции, которая не была завершена до сбоя.
    - После завершения этого этапа база данных возвращается в согласованное состояние, и можно продолжить работу.

### Пример работы алгоритма ARIES

Предположим, что у нас есть база данных, в которой выполняются несколько транзакций. В процессе работы возникает сбой (например, система неожиданно выключается). При восстановлении ARIES выполнит следующие шаги:

1. **Анализ**:
    
    - Система проверяет журнал транзакций, начиная с последней контрольной точки.
    - Находятся активные на момент сбоя транзакции и страницы данных, которые были изменены.
2. **Повторное выполнение (Redo)**:
    
    - Повторяются все операции по изменению данных, которые были зафиксированы, но не записаны на диск. Это гарантирует, что все изменения, которые должны были быть сделаны, действительно применены.
3. **Откат (Undo)**:
    
    - Все незавершенные транзакции (которые не были зафиксированы на момент сбоя) отменяются. Таким образом, база данных возвращается в согласованное состояние, исключающее частично выполненные операции.

### Дополнительные особенности ARIES

1. **Physiological Logging**: ARIES использует комбинацию физического и логического логирования. Это называется **физиологическое логирование**. В нем логируются логические операции над объектами базы данных, но изменения фиксируются на уровне страниц (блоков) данных, а не отдельных строк. Это облегчает восстановление и улучшает производительность.
    
2. **Selective Redo**: ARIES применяет только те операции Redo, которые необходимы. Это называется **избирательным повторным выполнением** (Selective Redo). Система не повторяет изменения страниц данных, которые уже были записаны на диск.
    
3. **Compensation Log Records (CLRs)**: Во время выполнения операций Undo ARIES записывает **компенсационные записи** (Compensation Log Records, CLR). Эти записи фиксируют информацию о том, что операция Undo была успешно выполнена. Это предотвращает повторное выполнение операций Undo при последующих сбоях.
    

### Преимущества ARIES

1. **Эффективное восстановление**: ARIES обеспечивает быстрое восстановление после сбоев, поскольку использует контрольные точки и избирательное выполнение операций.
    
2. **Журналирование с минимальными затратами**: Использование WAL позволяет минимизировать количество операций ввода-вывода на диск.
    
3. **Поддержка сложных транзакций**: ARIES поддерживает параллельные и вложенные транзакции, что делает его эффективным для сложных и масштабных транзакционных систем.
    

### Заключение

Алгоритм ARIES обеспечивает надежное и эффективное восстановление баз данных после сбоев, минимизируя потери данных и время простоя. Он использует подход WAL для журналирования изменений, а также предлагает механизмы оптимизации, такие как контрольные точки и компенсационные записи, для ускорения восстановления. ARIES стал основой для многих современных СУБД, включая PostgreSQL, DB2 и другие, благодаря своей гибкости и надежности.

### Возможные сценарии

#### 1. **Изменения не записались в WAL из-за сбоя перед фиксацией**

- Если произошел сбой **до фиксации** (commit), т.е. до того, как данные записались в WAL, система просто проигнорирует эти изменения. Такие транзакции считаются незафиксированными, и при восстановлении они будут отменены (откат Undo).
- Это нормальная и ожидаемая ситуация, которая не приводит к потере данных, так как данные считались **нефиксированными** (по сути, они не существовали для внешнего мира).

#### 2. **Изменения зафиксированы, но не успели записаться в журнал WAL**

- Такой сценарий **невозможен** в PostgreSQL из-за самого принципа Write-Ahead Logging. WAL всегда записывается **перед** фиксацией транзакции. Только после того, как данные в WAL записаны на диск, сервер возвращает пользователю подтверждение о фиксации транзакции.
- Если WAL не успеет записаться (например, из-за сбоя оборудования), то фиксация транзакции просто не произойдет, и при восстановлении система откатит любые незавершенные изменения.

#### 3. **Сбой после записи в WAL, но до применения изменений к основным данным**

- Если транзакция была успешно записана в WAL, но изменения еще не успели быть применены к основной базе (например, они остались в оперативной памяти), при следующем старте система восстановит данные из WAL.
- Это **сценарий восстановления** (Redo): при перезапуске PostgreSQL читает журнал WAL и применяет зафиксированные изменения, которые еще не были записаны в саму базу.

### Как PostgreSQL гарантирует надежность WAL?

1. **Механизм контрольных точек (Checkpoints)**:
    
    - Контрольные точки создаются периодически и сбрасывают все "грязные" страницы (измененные, но не записанные на диск) в основной файл базы данных. Это уменьшает объем журнала WAL, который нужно будет просматривать при восстановлении.
    - Контрольные точки позволяют ограничить количество данных, которые придется восстанавливать из WAL после сбоя.
2. **Конфигурация `synchronous_commit`**:
    
    - PostgreSQL имеет параметр конфигурации **`synchronous_commit`**, который определяет, как жестко сервер должен гарантировать запись WAL на диск.
    - Когда **`synchronous_commit = on`** (по умолчанию), PostgreSQL не вернет клиенту сообщение об успешной фиксации транзакции до тех пор, пока WAL не будет физически записан на диск.
    - В случае **`synchronous_commit = off`**, транзакция может быть зафиксирована, но запись в WAL может быть отложена. Это может повысить производительность, но снижает гарантии сохранности данных в случае сбоя (возможны потери последних транзакций).
3. **Резервное копирование WAL (Archiving WAL)**:
    
    - PostgreSQL поддерживает архивирование WAL. Это особенно полезно в случае длительного хранения данных для резервного восстановления или репликации.
    - Архивирование WAL происходит параллельно с записью текущих изменений, что позволяет восстанавливать систему до любого момента времени.

### Заключение

Изменения **не могут** не записаться в WAL, если они зафиксированы, потому что запись в WAL — это обязательный шаг перед фиксацией транзакции. Если произошел сбой до фиксации или до записи в WAL, транзакция просто не завершится, и все изменения будут откатаны. Это гарантирует, что система всегда восстанавливается в согласованное состояние, даже после критических сбоев.