---
title: Как данные обрабатываются в PostgreSQL
tags:
  - PostgreSql
related_topics: 
created: 2024-09-26 13:40
modified: 2024-09-27T12:16:45+03:00
questions: 
notes: 
links: 
---

### Правильный порядок операций:

1. **Запись данных в `shared buffers` (в памяти)**:
    
    - Когда происходит операция изменения данных (например, `INSERT`, `UPDATE` или `DELETE`), измененные страницы данных сначала записываются в **`shared buffers`** (буферы данных в оперативной памяти).
    - Эти буферы представляют собой кэш страниц таблиц, и изменения вносятся в них до того, как данные записываются на диск.
2. **Создание записи в WAL Buffers**:
    
    - Перед тем как транзакция будет зафиксирована (сделана `COMMIT`), PostgreSQL создает запись в **WAL Buffers** (буфер журнала WAL в оперативной памяти).
    - Эти записи фиксируют, какие изменения были внесены в данные. WAL Buffers работают как временное хранилище перед тем, как данные будут записаны на диск в WAL файлы.
3. **WAL Writer записывает данные из WAL Buffers на диск**:
    
    - После того как изменения попадают в WAL Buffers, процесс **WAL Writer** записывает их на диск в **WAL файлы**. Это гарантирует, что журнал всех изменений будет сохранен даже в случае сбоя.
    - <mark class="hltr-red">Транзакция **не будет зафиксирована** до тех пор, пока записи не окажутся на диске в WAL.</mark>
4. **Фиксация транзакции (COMMIT)**:
    
    - Только после того, как **WAL Writer** записал изменения на диск (в WAL файлы), транзакция может быть зафиксирована. Это означает, что данные гарантированно могут быть восстановлены после сбоя.
5. **Запись данных из `shared buffers` на диск (асинхронно)**:
    
    - После фиксации транзакции измененные страницы данных в `shared buffers` могут оставаться в памяти. Они будут записаны на диск позже, процессом **Checkpointer** или когда буферы данных заполнены.
    - Важно, что даже если страницы данных из `shared buffers` еще не записаны на диск, они могут быть восстановлены из WAL в случае сбоя.

### Выводы о порядке операций:

- **Первый шаг**: данные изменяются в **`shared buffers`**.
- **Затем**: создается запись об этих изменениях в **WAL Buffers**.
- **Потом**: процесс **WAL Writer** записывает данные из WAL Buffers на диск.
- **После этого**: транзакция фиксируется (COMMIT), и только потом измененные страницы данных из `shared buffers` записываются на диск.

Таким образом, **WAL (Write-Ahead Logging)** действительно работает **после изменения данных в shared buffers**, но **до записи данных на диск**. Это ключевое условие для обеспечения надежности транзакций в PostgreSQL.