---
title: Shared_buffer  vs Work_mem
tags:
  - PostgreSql
related_topics: 
created: 2024-09-27 12:08
modified: 2024-09-27T12:09:58+03:00
questions: 
notes: 
links: 
---

### Shared Buffers (буфер обмена)

**Shared Buffers** — это<mark class="hltr-red"> общая (shared) память, которая используется для кэширования страниц данных и индексов, загружаемых с диска.</mark> Этот кэш позволяет ускорить доступ к данным, избегая необходимости постоянно обращаться к файлам на диске. Основные моменты про shared_buffers:

- **Используется для чтения и записи данных**: Когда PostgreSQL считывает или записывает данные в таблицы или индексы, сначала данные загружаются в shared_buffers. После изменений они остаются в буфере и позже синхронизируются с диском.
- **Общий доступ**: Эта <mark class="hltr-purple">область памяти используется всеми процессами сервера, чтобы избежать дублирования чтения тех же данных разными запросами.</mark>
- **Буферизация данных**: Это, по сути, механизм кэширования, чтобы чаще оперировать данными в памяти, чем на диске.

### Work Mem (рабочая память)

**Work_mem** — это параметр, который <mark class="hltr-green2">определяет количество памяти, выделяемой для операций, требующих значительных вычислений в конкретном процессе.</mark> В отличие от shared_buffers, это память, используемая **локально** для выполнения временных операций для **каждого запроса отдельно**. Это очень важно для таких операций, как:

- **Сортировки (ORDER BY)**: Когда вы выполняете сортировку данных, PostgreSQL выделяет определенное количество памяти для хранения данных, которые нужно отсортировать. Если данных слишком много для этого объема памяти, они будут временно записаны на диск.
- **Хеширование (Hash Join или Hash Aggregate)**: Во время создания хеш-таблицы для соединения или агрегации, PostgreSQL использует work_mem. Если данных больше, чем может быть размещено в этой памяти, они будут храниться во временных файлах на диске.
- **Группировки (GROUP BY)** и **удаление дубликатов (DISTINCT)**: Эти операции могут требовать больших объемов памяти для хранения промежуточных результатов.

### Почему нужна отдельная рабочая память (work_mem)?

1. **Shared_buffers не предназначен для промежуточных данных**: Shared_buffers используется для кэширования **страниц данных** и индексов, которые читаются или пишутся из/на диск. Он не используется для хранения промежуточных результатов операций, таких как сортировка или хеширование, поскольку эти данные не должны быть доступны другим процессам. Если бы такие данные записывались в shared_buffers, это замедляло бы работу, увеличивая конкуренцию за общие ресурсы и снижая эффективность использования памяти.
    
2. **Work_mem оптимизирован для операций**: Когда PostgreSQL сортирует данные или строит хеш-таблицу, промежуточные результаты не должны кэшироваться или становиться доступными другим процессам. Для этого используется **локальная память** (work_mem), что минимизирует влияние на другие запросы и делает операции более изолированными.
    
3. **Оптимизация больших запросов**: Если объем данных для сортировки или хеширования превышает размер work_mem, PostgreSQL записывает промежуточные результаты во **временные файлы** на диске, что, конечно, замедляет работу. Это сделано для предотвращения исчерпания оперативной памяти. В этом случае локальная память (work_mem) помогает избежать прямой конкуренции за общий буфер (shared_buffers).
### Пример работы сортировки с work_mem

Предположим, у вас есть запрос:

`SELECT * FROM employees ORDER BY last_name;`

При выполнении этого запроса PostgreSQL:

1. **Читает данные из таблицы `employees`**: Если страницы данных уже находятся в shared_buffers, они будут прочитаны оттуда. В противном случае данные будут загружены с диска в shared_buffers.
    
2. **Сортирует данные**: Для сортировки данных PostgreSQL выделяет область памяти, указанную параметром `work_mem`. Если данных слишком много для `work_mem`, PostgreSQL будет использовать временные файлы на диске для выполнения сортировки.
    

При этом **work_mem** используется исключительно для **временной обработки данных запроса** (сортировка, хеширование и т.д.), тогда как **shared_buffers** хранит сами данные таблиц и индексов, чтобы ускорить их чтение и запись.

### Итог

- **Shared Buffers**: используется для кэширования данных таблиц и индексов. Он ускоряет чтение/запись данных, но не предназначен для промежуточных операций, таких как сортировка или группировка.
- **Work_mem**: используется для промежуточных вычислительных операций (сортировка, хеширование, группировка и т.д.). Это локальная память для каждого процесса, которая позволяет эффективно обрабатывать большие объемы данных.

Обе эти области памяти работают вместе, обеспечивая как быстрый доступ к данным (через shared_buffers), так и производительность сложных запросов (через work_mem).