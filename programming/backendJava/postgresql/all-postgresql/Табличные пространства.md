---
title: Табличные пространства
tags:
  - PostgreSql
related_topics: 
created: 2024-10-10 15:27
modified: 2025-04-17T15:33:06+03:00
questions: 
notes: 
links: 
---

![[Pasted image 20241010152808.png]]
![[Pasted image 20241010152836.png]]
![[Pasted image 20241010153035.png]]


**Табличные пространства (tablespaces)** в PostgreSQL — это механизм, который позволяет пользователям управлять физическим размещением данных базы на файловой системе. Табличные пространства дают возможность определить, на каких устройствах хранения (дисках) будут располагаться данные конкретных таблиц или индексов. Это особенно полезно в крупных или производительных системах, где важно распределить нагрузку между различными физическими или логическими хранилищами.

### Основные цели и задачи табличных пространств:

1. **Разделение данных по различным устройствам хранения**:  
    Табличные пространства позволяют хранить разные таблицы или индексы на разных физических дисках. Это может быть полезно для:
    
    - Оптимизации производительности: можно вынести интенсивно используемые данные на быстрые SSD-накопители, а менее критичные данные — на медленные HDD.
    - Увеличения объёма хранения: если место на одном диске заканчивается, можно создать табличное пространство на другом диске.
2. **Управление ресурсами**:  
    Табличные пространства могут использоваться для разграничения ресурсов между различными пользователями или схемами. Например, можно создать отдельное табличное пространство для конкретной базы данных или приложения, чтобы отслеживать их использование дискового пространства.
    
3. **Облегчение резервного копирования и восстановления**:  
    Использование разных табличных пространств позволяет выполнять выборочное резервное копирование или восстановление данных. Например, можно отдельно бэкапить критичные данные, которые хранятся в отдельном табличном пространстве.
    
4. **Хранение данных в разных файловых системах**:  
    В некоторых случаях различные файловые системы могут быть настроены с разными параметрами. Табличные пространства позволяют использовать файловые системы с нужными характеристиками для конкретных данных (например, для журналов транзакций может использоваться файловая система с высокой производительностью записи).
    

### Как создать и использовать табличные пространства:

1. **Создание табличного пространства**: Чтобы создать табличное пространство, используется команда `CREATE TABLESPACE`. Пример:
```sql
CREATE TABLESPACE fast_space LOCATION '/mnt/ssd';

```
- В этом примере создаётся табличное пространство, которое будет использовать каталог `/mnt/ssd` для хранения данных.
    
2. **Привязка таблиц и индексов к табличному пространству**: При создании таблицы или индекса можно указать, в каком табличном пространстве они должны храниться:

```sql
CREATE TABLE my_CREATE TABLESPACE fast_space LOCATION '/mnt/ssd';
CREATE TABLESPACE fast_space LOCATION '/mnt/ssd';
table (id int, data text) TABLESPACE fast_space;
```
3. **Перемещение существующих объектов в другое табличное пространство**: Существующие таблицы можно перемещать в новое табличное пространство с помощью команды `ALTER TABLE`:
```sql
ALTER TABLE my_table SET TABLESPACE fast_space;
```
### Когда нужно применять табличные пространства?

Табличные пространства не всегда необходимы, и их использование зависит от требований конкретной системы:

- **Малые и средние базы данных**:  
    В небольших базах данных, где данные хранятся на одном диске и нагрузка на систему невелика, использование табличных пространств может быть избыточным. В таких случаях можно обойтись стандартным механизмом хранения.
    
- **Крупные базы данных и высоконагруженные системы**:  
    Табличные пространства полезны в системах с большими объёмами данных или высокой нагрузкой, где нужно:
    
    - **Разделить данные по устройствам хранения**. Например, хранить индексы на одном быстром SSD-диске, а исторические данные на более медленном, но большем по объёму HDD.
    - **Увеличить надёжность и контроль за хранением данных**. Например, можно использовать разные диски для таблиц с высокой частотой чтения и записи (например, журналов транзакций и индексов).
- **Обслуживание и резервное копирование**:  
    В больших корпоративных базах данных с жёсткими требованиями к резервному копированию и восстановлению табличные пространства помогают проще управлять данными — можно делать отдельные бэкапы для критичных и не критичных данных.
    

### Нюансы и рекомендации:

1. **Продуманный выбор устройств хранения**:  
    Важно правильно выбрать, на какие диски или файловые системы распределять данные. Например, логи транзакций (WAL) лучше хранить на высокоскоростных SSD, в то время как архивные данные или бэкапы можно хранить на медленных, но объёмных HDD.
    
2. **Мониторинг свободного места**:  
    Если табличное пространство привязано к конкретному устройству, важно следить за тем, чтобы на нём было достаточно места. Если на диске закончится свободное пространство, система не сможет записывать новые данные, что может привести к сбоям.
    
3. **Не перегружайте файловую систему**:  
    Если несколько табличных пространств хранятся на одной файловой системе, это может привести к снижению производительности. Рекомендуется использовать отдельные диски или RAID-массивы для разных табличных пространств, чтобы распределить нагрузку.
    
4. **Рекомендации по использованию индексов**:  
    Если нужно максимизировать производительность, индексы можно хранить на более быстром устройстве (например, на SSD), чем сами данные, так как индексы часто требуют более быстрых операций чтения.
    
5. **Перенос существующих данных**:  
    Если данные уже созданы, можно переносить их в новое табличное пространство, но это может потребовать времени и ресурсов. Рекомендуется планировать такие операции в периоды низкой нагрузки.
    

### Вывод:

Табличные пространства — это мощный инструмент для управления физическим размещением данных в PostgreSQL. Их использование может быть полезным в больших и нагруженных системах, где важно распределить данные по разным устройствам хранения для повышения производительности и надёжности. Однако в небольших системах или при отсутствии особых требований к хранению данных их использование может быть излишним.

-- перейдем в домашний каталог пользователя postgres в ОС линукс

```
cd ~

pwd

mkdir temp_tblspce
```

```
psql
```

```
CREATE TABLESPACE ts location '/var/lib/postgresql/temp_tblspce';

\db

CREATE DATABASE app TABLESPACE ts;

\c app

\l+ -- посмотреть дефолтный tablespace

CREATE TABLE test (i int);

CREATE TABLE test2 (i int) TABLESPACE pg_default;

SELECT tablename, tablespace FROM pg_tables WHERE schemaname = 'public';

ALTER TABLE test set TABLESPACE pg_default;

SELECT oid, spcname FROM pg_tablespace; -- oid унимальный номер, по кторому можем найти файлы

SELECT oid, datname,dattablespace FROM pg_database;
```

-- всегда можем посмотреть, где лежит таблица

```
SELECT pg_relation_filepath('test2');
```

-- Узнать размер, занимаемый базой данных и объектами в ней, можно с помощью ряда функций.

```
SELECT pg_database_size('app');
```

-- Для упрощения восприятия можно вывести число в отформатированном виде:

```
SELECT pg_size_pretty(pg_database_size('app'));
```

-- Полный размер таблицы (вместе со всеми индексами):

```
SELECT pg_size_pretty(pg_total_relation_size('test2'));
```

-- И отдельно размер таблицы...

```
SELECT pg_size_pretty(pg_table_size('test2'));
```

-- ...и индексов:

```
SELECT pg_size_pretty(pg_indexes_size('test2'));
```

-- !!! с дефолтным неймспейсом не все так просто !!!

```
SELECT count(*) FROM pg_class WHERE reltablespace = 0;
```


-----

### Шардирование:

Шардирование — это метод горизонтального масштабирования, при котором данные разделяются на несколько частей (шардов), каждая из которых может храниться на отдельном сервере или в отдельной базе данных. Каждому шару назначается уникальная часть данных. Шардирование полезно, когда база данных становится слишком большой для одного сервера и требуется разделение нагрузки.

Например, если у вас есть таблица с данными пользователей, вы можете разделить её по регионам или по ID пользователя, так чтобы каждый шард хранил только часть данных:

- Шард 1: данные пользователей с ID от 1 до 1,000,000.
    
- Шард 2: данные пользователей с ID от 1,000,001 до 2,000,000.
    

### Отличие от табличных пространств:

1. **Масштабирование**:
    
    - **Табличное пространство** управляет местоположением данных в пределах одного сервера.
        
    - **Шардирование** позволяет распределить данные между несколькими серверами или даже географически распределёнными центрами обработки данных.
        
2. **Применение**:
    
    - **Табличные пространства** используются для организации хранения данных внутри одного сервера (например, оптимизация I/O, управление дисковым пространством).
        
    - **Шардирование** используется для масштабирования, когда объём данных превышает возможности одного сервера.
        
3. **Управление**:
    
    - Табличные пространства не меняют способ распределения данных между серверами. Это скорее способ организации на уровне файловой системы.
        
    - Шардирование требует дополнительной логики для маршрутизации запросов и балансировки нагрузки между различными серверами.
        

Табличные пространства — это локальная настройка для управления данными на одном сервере, а шардирование — это способ горизонтального масштабирования для распределения данных между несколькими серверами.