---
title: Хэш-таблица PG
tags:
  - PostgreSql
related_topics: 
created: 2024-09-27 11:51
modified: 2024-09-27T12:03:23+03:00
questions: 
notes: 
links: 
---

**Хеш-таблицы** в запросах —<mark class="hltr-yellow"> это особая структура данных, которую использует PostgreSQL</mark> (и другие СУБД) д<mark class="hltr-yellow">ля оптимизации операций доступа к данным</mark>. В контексте SQL-запросов хеш-таблицы<mark class="hltr-yellow"> чаще всего используются при выполнении таких операций, как соединения (JOIN), группировки (GROUP BY) и удаления дубликатов (DISTINCT).</mark> Основная <mark class="hltr-green2">задача хеш-таблицы — ускорить поиск и сопоставление данных.</mark>

### Как работают хеш-таблицы в запросах:

1. **Hash Join** (хеш-соединение): <mark class="hltr-green2">Хеш-соединение — это один из методов соединения таблиц, который использует хеш-таблицы для сопоставления строк из двух таблиц. </mark><mark class="hltr-red">PostgreSQL выбирает этот метод, если он оказывается наиболее оптимальным по сравнению с другими способами</mark> (например, Nested Loop Join или Merge Join).
    
    <mark class="hltr-orange">Процесс выполнения хеш-соединения включает следующие этапы:</mark>
    
    - **Построение хеш-таблицы**:<mark class="hltr-purple"> PostgreSQL сначала выбирает одну из таблиц, загружает её строки в память и строит по ним хеш-таблицу, используя значения соединяющихся колонок как ключи.</mark>
    - **Присоединение**: <mark class="hltr-blue">Затем сервер проходит по второй таблице, используя значения соединяющихся колонок для поиска соответствий в хеш-таблице, чтобы найти строки для соединения.</mark>
    
    **Пример:**

```sql
EXPLAIN SELECT * FROM employees e
JOIN departments d ON e.department_id = d.id;

```
- В результате запроса с использованием команды `EXPLAIN`, PostgreSQL может выбрать план с использованием `Hash Join`, если это самый эффективный способ соединения таблиц.
    
- **Hash Aggregate** (хеш-агрегация): <mark class="hltr-green2">Когда запрос выполняет группировку данных</mark> (например, `GROUP BY`), PostgreSQL <mark class="hltr-green2">может использовать хеш-таблицы для ускорения агрегации. </mark>Сначала<mark class="hltr-red"> сервер строит хеш-таблицу, в которой ключами являются значения, по которым выполняется группировка, а затем использует эту таблицу для подсчета агрегированных значений (например, суммы или количества).</mark>
    
    **Пример:**

```sql
EXPLAIN SELECT department_id, COUNT(*)
FROM employees
GROUP BY department_id;

```
- В зависимости от данных и настроек оптимизации, PostgreSQL может выбрать использование `Hash Aggregate` для ускорения вычислений.
    
- **Hash-Based DISTINCT** (<mark class="hltr-blue">хеширование для удаления дубликатов</mark>): Для операции удаления дубликатов с использованием `DISTINCT`, <mark class="hltr-red">PostgreSQL может также воспользоваться хеш-таблицей. В таком случае значения помещаются в хеш-таблицу, и если они уже присутствуют в таблице, они не добавляются в результат.</mark>
    
    **Пример:**


```sql
EXPLAIN SELECT DISTINCT department_id
FROM employees;

```
1. Если хеш-таблица будет наиболее эффективным способом выполнения этой операции, PostgreSQL применит `Hash`.
    

### Преимущества хеш-таблиц:

1. **Быстрота**: Операции поиска в хеш-таблицах выполняются за **O(1)** (время доступа постоянно и не зависит от размера данных), что делает их крайне эффективными для операций поиска, особенно при соединениях или группировках.
2. **Меньшие ресурсы**: Хеш-соединения могут быть более эффективны с точки зрения использования памяти и ресурсов, особенно на больших объемах данных, чем, например, `Nested Loop Join`.
3. **Поддержка больших наборов данных**: Хеш-таблицы хорошо работают с большими объемами данных, особенно когда они помещаются в память.

### Недостатки хеш-таблиц:

1. **Ограничения по памяти**: <mark class="hltr-purple">Хеш-таблицы эффективны, когда данные могут быть загружены в оперативную память</mark>. Если объем данных слишком велик, это может привести к необходимости использования временных файлов на диске, что снижает производительность.
2. **Неоптимальны для отсортированных данных**: <mark class="hltr-purple">Хеш-соединения не сохраняют порядок данных</mark>, поэтому если запрос требует сортировки (`ORDER BY`), это потребует дополнительных операций.
3. **Не подходят для малых наборов данных**<mark class="hltr-purple">: Для небольших таблиц хеш-соединения могут оказаться излишними, так как накладные расходы на построение хеш-таблицы могут перевесить выгоды.</mark>

### Пример анализа плана запроса с использованием хеш-таблиц:

Можно использовать команду `EXPLAIN` для анализа плана выполнения запроса и понять, используется ли хеш-таблица.
```sql
EXPLAIN ANALYZE SELECT * FROM employees e
JOIN departments d ON e.department_id = d.id;

```

Если PostgreSQL выберет хеш-соединение, в выводе плана будет что-то вроде этого:

```sql
Hash Join  (cost=37.25..85.62 rows=100 width=200)
  Hash Cond: (e.department_id = d.id)
  -> Seq Scan on employees e  (cost=0.00..34.00 rows=100 width=150)
  -> Hash  (cost=17.25..17.25 rows=100 width=50)
       -> Seq Scan on departments d  (cost=0.00..17.25 rows=100 width=50)

```
Здесь видно, что PostgreSQL использует **`Hash Join`** для соединения таблиц, строя хеш-таблицу по колонке `d.id` таблицы `departments`, а затем выполняет сканирование и сопоставление с таблицей `employees`.

### Итог:

**Хеш-таблицы** в PostgreSQL — это мощный инструмент оптимизации, который используется для ускорения операций, связанных с соединениями, группировкой и удалением дубликатов. Они позволяют эффективно обрабатывать данные за счёт быстрого поиска и сопоставления, но при этом имеют свои ограничения, связанные с объёмом данных и необходимыми ресурсами.