---
title: Сканирование по битовой карте Bitmap Heap Scan
tags:
  - PostgreSql
related_topics: 
created: 2024-11-26 16:27
modified: 2024-11-26T16:36:58+03:00
questions: 
notes: 
links: 
---

![[Pasted image 20241126162829.png]]

Давай разберемся с твоими вопросами по **Bitmap Index Scan** и **Bitmap Heap Scan**, чтобы стало понятно, почему страница читается только один раз, несмотря на возможные версии строк.

---

### 1. **Что такое Bitmap Index Scan и Bitmap Heap Scan?**

Когда база данных использует индексы для поиска строк, она может выбрать стратегию **Bitmap Index Scan** вместо простого индексного сканирования (`Index Scan`). Это делается для оптимизации запросов, особенно если:

- Условие затрагивает несколько индексов или требует фильтрации большого количества строк.
- Целевые строки раскиданы по многим страницам таблицы.

Вот как это работает:

1. **Bitmap Index Scan:**
    
    - База данных строит **битовую карту** (bitmap), которая указывает, какие строки (точнее, их позиции — "TID") нужно извлечь из таблицы.
    - Битовая карта по сути является массивом, где каждая позиция соответствует строке в таблице:
        - 1 — строку нужно прочитать.
        - 0 — строку можно пропустить.
2. **Bitmap Heap Scan:**
    
    - База данных использует битовую карту, чтобы оптимально прочитать только те страницы таблицы, в которых есть нужные строки.
    - В каждой странице проверяются только строки, отмеченные в битовой карте.

---

### 2. **Почему страница читается один раз?**

Когда база данных выполняет **Bitmap Heap Scan**, она читает каждую страницу таблицы **только один раз**, даже если в этой странице находятся несколько строк, удовлетворяющих условию. Вот как это работает:

1. **Сканирование индекса:**
    
    - Индекс сканируется, и для каждой строки, подходящей под условие, отмечается ее позиция (TID) в битовой карте.
2. **Оптимизация чтения:**
    
    - Битовая карта группирует TID'ы по страницам. Это позволяет базе данных заранее знать, какие страницы нужно читать.
    - При чтении страницы все строки, которые находятся в этой странице и помечены в битовой карте, проверяются на соответствие условиям запроса.
3. **Обработка версий строк:**
    
    - Когда страница читается, база данных проверяет каждую строку на:
        - Удовлетворение условия запроса.
        - Видимость строки (учитываются транзакционные версии — MVCC, Multi-Version Concurrency Control).
    - Строки, которые **не видимы для текущей транзакции** или не соответствуют условиям, отбрасываются.
    - Это значит, что **все версии строк, которые находятся на странице, проверяются за один проход**.

---

### 3. **Почему это эффективно?**

Ключевая идея здесь — **уменьшить количество обращений к страницам таблицы**. Вместо того чтобы читать одну страницу для каждой строки, база данных группирует запросы к страницам:

- **Если строк несколько:**
    
    - Например, в странице хранятся 100 строк, из которых 5 подходят под условия. Битовая карта гарантирует, что страница читается **только один раз**, а все подходящие строки проверяются за один проход.
- **Если у строк есть версии:**
    
    - Если строка имеет несколько версий, база данных проверяет все версии строки на видимость (соответствие MVCC). Это делается за тот же проход, когда страница читается, так что второй раз страница уже не читается.

---

### 4. **Что произойдет, если у страницы много подходящих строк с версиями?**

1. **Битовая карта:**
    
    - Индекс указывает только на позиции строк (TID), удовлетворяющих условиям. Каждая строка проверяется уже на этапе чтения страницы.
2. **Строки с версиями:**
    
    - Когда строка имеет несколько версий из-за транзакций, все версии хранятся на одной странице. База данных проверяет:
        - Какая из версий строки актуальна для текущей транзакции.
        - Удовлетворяет ли эта версия условиям запроса.
    - Эта проверка выполняется **за одно чтение страницы**.

---

### 5. **Почему не нужно читать страницу несколько раз?**

Битовая карта позволяет базе данных:

- Заранее знать, какие строки на странице стоит проверять.
- Избежать ненужного обращения к страницам, в которых нет подходящих строк.
- На этапе одного чтения страницы обрабатывать сразу **все строки и их версии**, которые могут быть релевантны запросу.

Если бы база данных читала страницу заново для каждой строки, это сильно снизило бы производительность.

---

### 6. **Пример работы с Bitmap Index Scan и Bitmap Heap Scan**

**Таблица "Покупки":**

|ID|Покупатель|Сумма|Дата|
|---|---|---|---|
|1|Иван|500|2024-01-01|
|2|Ольга|1500|2024-01-02|
|3|Иван|2000|2024-01-03|
|4|Алексей|700|2024-01-04|
|5|Ольга|800|2024-01-05|


`SELECT Покупатель, Сумма FROM Покупки WHERE Покупатель = 'Иван' OR Сумма > 1000;`

**Что делает база:**

1. **Bitmap Index Scan:**
    
    - Первый индекс по "Покупатель" находит строки 1 и 3 (Иван).
    - Второй индекс по "Сумма" находит строки 2 и 3 (Сумма > 1000).
    - База объединяет результаты индексов и строит битовую карту:
        
        less
        
        Копировать код
        
        `Строки: [1, 2, 3] (группируются по страницам)`
        
2. **Bitmap Heap Scan:**
    
    - База идет к страницам таблицы, где хранятся строки 1, 2 и 3.
    - Читает каждую страницу **только один раз**, проверяя все строки, которые отмечены в битовой карте.
    - Проверяет версии строк для текущей транзакции (если есть) и исключает невидимые строки.

**Результат:** База вернет строки:

- Иван, 500
- Ольга, 1500
- Иван, 2000

---

### 7. **Итог**

- **Почему страница читается один раз?**
    
    - Битовая карта заранее группирует запросы к страницам.
    - Все строки и их версии на странице проверяются за один проход.
    - Это минимизирует количество чтений страниц таблицы.
- **Какие преимущества?**
    
    - Снижается количество обращений к таблице.
    - Проверяются только те строки, которые указаны в битовой карте.
    - Эффективная работа с большими объемами данных.

Если есть еще вопросы, могу разобрать более детально!