---
title: Буферный кеш и журнал
tags:
  - PostgreSql
related_topics: 
created: 2024-10-03 14:54
modified: 2024-10-11T18:33:54+03:00
questions: 
notes: 
links: 
---

----
[[sql буферный кеш]]

---


![[Pasted image 20241003145704.png]]

![[Pasted image 20241003145927.png]]
![[Pasted image 20241003150534.png]]

![[Pasted image 20241003153804.png]]
![[Pasted image 20241011180918.png]]![[Pasted image 20241011180930.png]]

 ### Шаг 1: Запрос анализируется

Когда ты отправляешь запрос, PostgreSQL **анализирует** его и понимает, что нужно найти строку, где `id = 100`. Чтобы это сделать, PostgreSQL определяет, **в какой странице** данных (блоке) хранится нужная строка. Таблицы в базе данных делятся на **страницы** (размер каждой страницы по умолчанию — 8 КБ), и твои данные хранятся на этих страницах.

### Шаг 2: Проверка буферного пула (буфер в памяти)

Теперь PostgreSQL должен **найти** страницу данных, где находится строка с `id = 100`. Прежде чем лезть на диск, база данных проверяет, а не лежит ли эта страница уже в оперативной памяти (в буфере).

Чтобы проверить, PostgreSQL использует **хеш-таблицу** — это специальная структура в памяти, которая помогает быстро найти, есть ли страница уже в буфере.

#### Что делает PostgreSQL:

1. PostgreSQL смотрит на таблицу `employees` и определяет, где на диске хранятся её данные.
    - Представь, что у таблицы `employees` есть **идентификатор файла**, например, `RelFileNode = 12345`. Это уникальный номер файла в базе данных, который хранит данные таблицы.
2. PostgreSQL понимает, что данные по `id = 100` находятся, скажем, в блоке **42** таблицы `employees`. Это будет номер страницы данных — **`BlockNumber = 42`**.

### Шаг 3: Хеш-таблица и поиск в буфере

Теперь PostgreSQL формирует **ключ для хеш-таблицы**. Этот ключ — это комбинация:

- **`RelFileNode`** (номер файла таблицы `employees`) = 12345
- **`BlockNumber`** (номер страницы, где хранится нужная строка) = 42

Этот ключ (12345, 42) позволяет PostgreSQL **быстро искать**, есть ли эта страница (блок данных) в памяти (буфере) или нет.

- Если страница **есть в буфере**, PostgreSQL просто берет данные из памяти. Это очень быстро, потому что чтение из оперативной памяти намного быстрее, чем чтение с диска.
    
- Если страницы **нет в буфере**, PostgreSQL обращается на диск, загружает страницу (блок) с номером 42 из файла таблицы `employees` и кладет её в буфер. После этого страница добавляется в хеш-таблицу, чтобы в следующий раз быстро найти её в памяти.
    

### Шаг 4: Возврат результата

Как только нужная страница (блок данных) найдена (либо в буфере, либо загружена с диска), PostgreSQL извлекает строку с `id = 100` и возвращает её тебе в виде результата запроса.

### Важно понять:

- **Хеш-таблица** просто помогает PostgreSQL **очень быстро** находить страницы данных в памяти. Если PostgreSQL каждый раз лазил бы на диск, это было бы очень медленно.
- Ключ для поиска в хеш-таблице — это **уникальная комбинация идентификатора файла таблицы** (`RelFileNode`) и **номера блока данных** (`BlockNumber`), где находятся данные.

### Пример для тупых (с повседневной аналогией):

Представь, что у тебя есть огромная библиотека с тысячами книг (это твоя база данных). Когда тебе нужно найти конкретную страницу в книге (это как блок данных с нужной строкой), ты сначала проверяешь, может, она уже лежит у тебя на столе (буфер в памяти).

Чтобы понять, есть ли нужная страница у тебя на столе, ты смотришь в записную книжку (это хеш-таблица), где ты отметил, какие страницы уже положил на стол. В записной книжке для каждой страницы ты записал:

- **номер книги** (это как `RelFileNode`)
- **номер страницы** (это как `BlockNumber`)

Если страница лежит на столе, ты берёшь её и читаешь. Если нет, ты идёшь в библиотеку (на диск), достаёшь книгу, открываешь её на нужной странице и кладёшь на стол для следующего использования.

**Идея** хеш-таблицы и буфера в том, что в следующий раз, когда тебе понадобится та же страница, ты быстро проверишь, есть ли она на столе, вместо того чтобы каждый раз ходить в библиотеку.

### Резюме:

1. **Ты делаешь запрос** — PostgreSQL должен найти данные.
2. **PostgreSQL проверяет** буфер (память) через **хеш-таблицу**: использует уникальный ключ, чтобы понять, лежат ли данные в памяти.
3. **Если данные в памяти** — PostgreSQL сразу берёт их.
4. **Если данных нет в памяти** — PostgreSQL лезет на диск, загружает данные и кладет их в память для дальнейшего быстрого доступа.

Так хеш-таблица и буфер помогают базе данных работать быстрее, минимизируя количество обращений к диску.


![[Pasted image 20241011182204.png]]
 ![[Pasted image 20241011182227.png]]
 ![[Pasted image 20241011182258.png]]
 ![[Pasted image 20241011182342.png]]
 ![[Pasted image 20241011182445.png]]
 ![[Pasted image 20241011183314.png]]
 