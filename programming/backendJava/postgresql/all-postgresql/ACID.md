---
title: ACID
tags:
  - PostgreSql
related_topics: 
created: 2024-09-26 17:00
modified: 2025-04-22T13:40:16+03:00
questions: 
notes: 
links: 
---

------
[[Все про ACID и BASE]]



------
#### ACID

**ACID** — это <mark class="hltr-yellow">набор свойств, обеспечивающих надежность и корректность транзакций в системах управления базами данных</mark>. Понимание этих принципов на глубоком уровне является критически важным для разработки высоконадежных и производительных приложений, особенно в условиях масштабирования, конкуренции и отказоустойчивости.

**ACID** — это аббревиатура, которая расшифровывается как:

1. **A** — **Atomicity (Атомарность)**
2. **C** — **Consistency (Согласованность)**
3. **I** — **Isolation (Изолированность)**
4. **D** — **Durability (Надежность)**

Каждое из этих свойств описывает ключевую характеристику транзакций и влияет на способ их обработки в базе данных. Рассмотрим каждое свойство подробно и на уровне архитектора системы.

---

### 1. **Atomicity (Атомарность)**

#### Определение:

Атомарность <mark class="hltr-yellow">означает, что каждая транзакция в базе данных является неделимой операцией.</mark> Транзакция либо **выполняется целиком**, либо не выполняется вовсе. Е<mark class="hltr-blue">сли в ходе выполнения транзакции происходит ошибка или сбой, все изменения, внесенные в систему, откатываются, и база данных возвращается в состояние, в котором она была до начала транзакции.</mark>

#### Пример:

Представим банковскую систему, в которой происходит перевод денег:

- Два действия: (1) списание денег с одного счёта, (2) зачисление денег на другой счёт.
- Если одно из этих действий завершается с ошибкой (например, сбой сети при записи во второй аккаунт), транзакция должна откатиться, чтобы избежать ситуации, когда деньги списаны, но не зачислены.

#### Как это реализовано:

- **Журналы транзакций (Transaction Log)**: В реляционных базах данных (например, PostgreSQL, MySQL, Oracle) <mark class="hltr-red">используется механизм журналирования</mark>. <mark class="hltr-green2">Перед изменением данных создаются записи в журнале, чтобы в случае сбоя можно было откатить изменения</mark>. Например, в PostgreSQL используется механизм **Write-Ahead Logging (WAL)**, который <mark class="hltr-yellow">фиксирует все изменения до их записи на диск, обеспечивая возможность отката в случае сбоя.</mark>
    
- **Команды `BEGIN`, `COMMIT`, `ROLLBACK`**: <mark class="hltr-purple">Эти команды используются для явного управления транзакциями</mark>. В случае успешного завершения транзакции вызывается `COMMIT`, фиксируя все изменения. В случае ошибки или сбоя используется `ROLLBACK` для отмены всех внесенных изменений.
    

---

### 2. **Consistency (Согласованность)**

#### Определение:

Согласованность <mark class="hltr-yellow">означает, что после завершения транзакции база данных должна остаться в **согласованном состоянии**</mark>, то ест<mark class="hltr-green2">ь все данные должны соответствовать определённым бизнес-правилам, ограничениям и схемам</mark>. Если транзакция нарушает согласованность данных (например, нарушает целостность ссылок или уникальность), она не должна завершаться успешно.

#### Пример:

Допустим, у нас есть таблица с ограничением уникальности на поле "email". Если транзакция пытается вставить два одинаковых email-адреса в эту таблицу, это нарушает согласованность данных, и такая транзакция должна быть отклонена.

#### Как это реализовано:

- **Ограничения целостности данных**:
    
    - **Первичный ключ (Primary Key)**: Гарантирует уникальность каждой записи.
    - **Внешний ключ (Foreign Key)**: Обеспечивает ссылочную целостность между таблицами.
    - **Проверочные ограничения (CHECK)**: <mark class="hltr-red">Ограничивают данные в таблицах согласно бизнес-правилам.</mark>
    - **Триггеры**: Могут использоваться для проверки и поддержания сложной бизнес-логики при изменении данных.
- **Откат транзакций**: <mark class="hltr-yellow">Если транзакция нарушает согласованность, база данных автоматически вызывает</mark> `ROLLBACK` и отменяет все изменения.

#### Причина-следственная связь:

Согласованность тесно связана с атомарностью. Если система обеспечивает атомарность, согласованность соблюдается. Например, при переводе денег между счетами согласованность может быть выражена в том, что сумма на обоих счетах до и после транзакции должна быть постоянной. Если атомарность нарушается, нарушается и согласованность, так как одна часть транзакции может выполниться, а другая — нет.

---

### 3. **Isolation (Изолированность)**

#### Определение:

Изолированность <mark class="hltr-red">означает, что транзакции, выполняемые одновременно, **не должны мешать друг другу**</mark>. <mark class="hltr-yellow">Каждая транзакция должна выполняться так, как будто она единственная в системе</mark>, даже если на самом деле несколько транзакций выполняются одновременно. Изолированность позволяет избежать проблем с конкурентным доступом к данным, таких как "грязное чтение" (dirty reads) или "потерянные обновления" (lost updates).

#### Уровни изолированности:

<mark class="hltr-yellow">Существует четыре основных уровня изолированности</mark>, которые описывают, какие виды конкуренции транзакций допускаются:

1. **Read Uncommitted (Чтение неподтвержденных данных)**: <mark class="hltr-blue">Транзакция может видеть изменения, которые еще не были зафиксированы другой транзакцией. Это самый слабый уровень изоляции.</mark>
2. **Read Committed (Чтение подтвержденных данных)**: <mark class="hltr-purple">Транзакция может видеть только те изменения, которые были зафиксированы.</mark>
3. **Repeatable Read (Повторяющееся чтение)**: Т<mark class="hltr-yellow">ранзакция видит только те данные, которые были зафиксированы до её начала, даже если другие транзакции позже изменили эти данные.</mark>
4. **Serializable (Сериализуемость)**:<mark class="hltr-red"> Самый высокий уровень изоляции, гарантирующий, что транзакции будут выполнены так, как будто они были выполнены последовательно одна за другой.</mark>

#### Пример:

Представим, что два пользователя одновременно снимают деньги с одного банковского счета:

- Если изолированность транзакций не обеспечена, оба пользователя могут видеть старый баланс счета, и оба могут попытаться снять деньги, что приведет к недопустимому отрицательному балансу.
- Уровень изоляции `Serializable` гарантирует, что одна транзакция будет завершена до того, как начнется другая.

#### Как это реализовано:

- **Механизмы блокировок (Locks)**: В реляционных базах данных для обеспечения изолированности транзакций используются различные виды блокировок. Например, <mark class="hltr-yellow">PostgreSQL использует </mark>**MVCC (Multiversion Concurrency Control)**, где <mark class="hltr-green2">каждая транзакция работает с "снимком" данных на момент её начала, что позволяет избежать конфликтов при параллельных транзакциях.</mark>
    
- **Пример:**
    
    - **MVCC**: Каждая транзакция видит только версию данных, актуальную на момент её старта, обеспечивая изолированность. Это позволяет транзакциям не блокировать друг друга при чтении, что повышает производительность при большом количестве одновременных запросов.

#### Причина-следственная связь:

Изолированность влияет на производительность системы, так как более строгие уровни изолированности требуют большего количества блокировок и версий данных, что может замедлить выполнение транзакций. Однако отсутствие изолированности может привести к некорректным результатам, что особенно важно в финансовых приложениях.

---

### 4. **Durability (Надежность)**

#### Определение:

Надежность означает, что после того, как транзакция была зафиксирована (с помощью команды `COMMIT`), её изменения будут **гарантированно сохранены**, даже если сразу после фиксации произойдет сбой (например, отключение питания или падение сервера).

#### Пример:

Представьте, что вы сделали перевод денег, и транзакция успешно завершилась (`COMMIT`). Даже если после этого сервер выходит из строя, запись о переводе должна быть сохранена, и при перезапуске системы данные должны быть в согласованном состоянии.

#### Как это реализовано:

- **Write-Ahead Logging (WAL)**: Это ключевой механизм обеспечения надежности. В PostgreSQL и других реляционных СУБД все изменения данных сначала записываются в WAL-журнал до того, как они применяются к основным таблицам. Это означает, что даже в случае сбоя можно восстановить данные из журнала транзакций.
    
- **Фоновые процессы**:
    
    - **Checkpointer**: Периодически записывает изменения из буферов на диск.
    - **WAL Writer**: Записывает данные в журнал транзакций до того, как изменения фиксируются в данных.
- **Файловая система и дисковая политика**: Для обеспечения надежности важно правильно настроить файловую систему и использовать механизмы, такие как `fsync`, которые гарантируют, что данные будут физически записаны на диск до завершения транзакции.
    

#### Причина-следственная связь:

Надежность напрямую связана с атомарностью и согласованностью. Даже если транзакция была зафиксирована, данные должны быть надежно записаны на диск, чтобы гарантировать их восстановление после сбоя. При этом важны не только внутренние механизмы базы данных, но и взаимодействие с операционной системой и аппаратным обеспечением (например, RAID-массивы, настройка кэша дисков).

---

### Взаимосвязь ACID-компонентов

Каждое из свойств ACID взаимосвязано и работает в тандеме для обеспечения надежности работы базы данных:

1. **Атомарность** обеспечивает, что транзакция либо завершится целиком, либо не завершится вовсе, что помогает избежать частичных изменений.
2. **Согласованность** гарантирует, что любые изменения, сделанные транзакцией, соответствуют бизнес-правилам и не нарушают целостности данных.
3. **Изолированность** предотвращает взаимное влияние транзакций друг на друга, что помогает избежать проблем с конкурентным доступом к данным.
4. **Надежность** обеспечивает сохранность данных после завершения транзакции, даже в случае сбоев системы.

---

### Вопросы на собеседовании на уровне Senior

**1. Как обеспечить атомарность в случае сбоя?**

- Ответ: Атомарность обеспечивается через механизмы журналирования транзакций, такие как Write-Ahead Logging (WAL). Это позволяет базе данных откатывать все изменения в случае сбоя.

**2. Как влияет уровень изоляции на производительность?**

- Ответ: Чем выше уровень изоляции, тем больше блокировок и версий данных создается, что снижает производительность. На практике часто используют уровень `Read Committed` для большинства операций, а для критичных — `Serializable`.

**3. Какой уровень изоляции выбрать для финансовых транзакций?**

- Ответ: Для финансовых транзакций предпочтительнее использовать уровень `Serializable`, чтобы гарантировать, что транзакции будут выполнены последовательно, избегая конфликтов.

**4. Как PostgreSQL реализует надежность?**

- Ответ: Надежность в PostgreSQL реализуется через механизм WAL, который записывает все изменения в журнал перед их применением. В случае сбоя база данных может восстановить данные из этого журнала.
