---
title: Нюансы работы с ссылками или как экономить память правильно
tags:
  - JVM
  - Job4j
related_topics: 
created: 2025-02-05 15:46
modified: 2025-02-05T16:32:14+03:00
questions: 
notes: 
links: 
---


----

#### Детали SoftReference
###### Особенности GC
GC начал свою работу и проходит по всем объектам в куче. В случае<mark class="hltr-red">, если объект в куче это Reference, то GC помещает этот объект в специальную очередь в которой лежат все Reference объекты. После прохождения по всем объектам GC берет очередь Reference объектов и по каждому из них решает удалять его из памяти или нет</mark>. Как именно принимается решение об удалении объекта — зависит от JVM. Но <mark class="hltr-yellow">общий контракт звучит следующим образом:</mark> _GC гарантировано удалит с кучи все объекты, доступные только по soft-ссылке, перед тем как бросит OutOfMemoryError_.

<mark class="hltr-green2">Вот как Hotspot принимает решение об удалении SoftReference</mark>: если посмотреть на реализацию SoftReference, то видно, что в классе <mark class="hltr-yellow">есть 2 переменные</mark> — private static long clock и private long timestamp. Каждый раз при запуске GC, <mark class="hltr-yellow">он сетит текущее время в переменную clock</mark>. Каждый раз при создании SoftReference, в timestamp записывается текущее значение clock. timestamp обновляется каждый раз при вызове метода get() (каждый раз, когда мы создаем strong-ссылку на объект). Это позволяет вычислить, сколько времени существует soft-ссылка после последнего обращения к ней.<mark class="hltr-blue"> Обозначим этот интервал буквой I</mark>.<mark class="hltr-blue"> Буквой F обозначим количество свободного места в куче в MB</mark>(мегабайтах). Константой<mark class="hltr-blue"> MSPerMB обозначим количество миллисекунд, сколько будет существовать soft-ссылка для каждого свободного мегабайта в куче.  </mark>
Дальше все просто, если <mark class="hltr-orange">I меньше или равно F * MSPerMB, то не удаляем объект. Если больше то удаляем</mark>.

Для изменения MSPerMB используем ключ **-XX:SoftRefLRUPolicyMSPerMB**. Дефалтовое значение — 1000 ms, а это означает что <mark class="hltr-red">soft-ссылка будет существовать (после того как strong-ссылка была удалена) 1 секунду за каждый мегабайт свободной памяти в куче.</mark> Главное не забыть что это все примерные расчеты, так как фактически soft-ссылка удалится только после запуска GC.  
Обратите внимание на то, что для удаления объекта, I должно быть строго больше чем F * MSPerMB. Из этого следует что созданная SoftReference проживет минимум 1 запуск GC. (*если не понятно почему, то это останется вам домашним заданием).  
В случае VM от IBM, привязка срока жизни soft-ссылки идет не к времени, а к количеству переживших запусков GC.

----
![[Pasted image 20250205160409.png]]

![[Pasted image 20250205160432.png]]
![[Pasted image 20250205160800.png]]


-----

##### WeakReference
Особенности GC
![[Pasted image 20250205162040.png]]
![[Pasted image 20250205162150.png]]


-----
##### PhantomReference

![[Pasted image 20250205162526.png]]
![[Pasted image 20250205162953.png]]


----
![[Pasted image 20250205163204.png]]